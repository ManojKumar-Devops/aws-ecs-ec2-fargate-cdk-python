name: Deploy ECS Blue/Green (Fargate + CodeDeploy)

on:
  push:
    branches: [ "ecs" ]
    paths:
      - "infra/**"
      - "app/**"
      - ".github/workflows/deploy-ecs-bg.yml"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: us-east-1
  ECR_REPO: hello-world-lab

jobs:
  deploy-ecs-bg:
    runs-on: [self-hosted, aws, cdk]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install CDK + Python deps
        run: |
          npm install -g aws-cdk
          python -m pip install --upgrade pip
          pip install -r infra/requirements.txt

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy NetworkStack
        working-directory: infra
        run: |
          rm -rf cdk.out
          cdk synth -c deploy_ec2_asg=false -c deploy_ecs=false -c deploy_ecs_bg=true
          aws cloudformation deploy \
            --stack-name NetworkStack \
            --template-file cdk.out/NetworkStack.template.json

      - name: Deploy EcrStack
        working-directory: infra
        run: |
          rm -rf cdk.out
          cdk synth -c deploy_ec2_asg=false -c deploy_ecs=false -c deploy_ecs_bg=true
          aws cloudformation deploy \
            --stack-name EcrStack \
            --template-file cdk.out/EcrStack.template.json

      - name: Login to Amazon ECR
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          aws ecr get-login-password --region "$AWS_REGION" | \
            docker login --username AWS --password-stdin \
            "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

      - name: Build and push image to ECR
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          cd app
          docker build -t "${ECR_REPO}:latest" .
          docker tag "${ECR_REPO}:latest" "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest"
          docker push "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest"

      - name: Set IMAGE_URI env
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "IMAGE_URI=${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest" >> $GITHUB_ENV

      # Roles are stored as Repo Variables
      - name: Set role envs
        run: |
          echo "ECS_EXEC_ROLE_ARN=${{ vars.ECS_EXEC_ROLE_ARN }}" >> $GITHUB_ENV
          echo "CODEDEPLOY_ROLE_ARN=${{ vars.CODEDEPLOY_ROLE_ARN }}" >> $GITHUB_ENV
          # optional:
          echo "ECS_TASK_ROLE_ARN=${{ vars.ECS_TASK_ROLE_ARN }}" >> $GITHUB_ENV

      - name: CDK synth (ECS Blue/Green enabled)
        working-directory: infra
        run: |
          rm -rf cdk.out
          cdk synth \
            -c deploy_ec2_asg=false \
            -c deploy_ecs=false \
            -c deploy_ecs_bg=true \
            -c image_uri=$IMAGE_URI \
            -c ecs_exec_role_arn=$ECS_EXEC_ROLE_ARN \
            -c codedeploy_role_arn=$CODEDEPLOY_ROLE_ARN \
            -c ecs_task_role_arn=$ECS_TASK_ROLE_ARN

      - name: Deploy ECS Blue/Green Stack (infra)
        working-directory: infra
        run: |
          aws cloudformation deploy \
            --stack-name EcsFargateBlueGreenStack \
            --template-file cdk.out/EcsFargateBlueGreenStack.template.json \
            --capabilities CAPABILITY_NAMED_IAM

      - name: Read outputs (cluster/service/codedeploy)
        id: outs
        run: |
          aws cloudformation describe-stacks \
            --stack-name EcsFargateBlueGreenStack \
            --query "Stacks[0].Outputs" \
            --output json > outputs.json

          echo "CLUSTER=$(jq -r '.[] | select(.OutputKey=="ClusterName") | .OutputValue' outputs.json)" >> $GITHUB_ENV
          echo "SERVICE=$(jq -r '.[] | select(.OutputKey=="ServiceName") | .OutputValue' outputs.json)" >> $GITHUB_ENV
          echo "CD_APP=$(jq -r '.[] | select(.OutputKey=="CodeDeployAppName") | .OutputValue' outputs.json)" >> $GITHUB_ENV
          echo "CD_DG=$(jq -r '.[] | select(.OutputKey=="CodeDeployGroupName") | .OutputValue' outputs.json)" >> $GITHUB_ENV
          echo "ALB_URL=$(jq -r '.[] | select(.OutputKey=="AlbUrl") | .OutputValue' outputs.json)" >> $GITHUB_ENV

      - name: Create Task Definition JSON (register new revision)
        run: |
          cat > taskdef.json <<'EOF'
          {
            "family": "hello-bg",
            "networkMode": "awsvpc",
            "requiresCompatibilities": ["FARGATE"],
            "cpu": "256",
            "memory": "512",
            "executionRoleArn": "__EXEC_ROLE__",
            "taskRoleArn": "__TASK_ROLE__",
            "containerDefinitions": [
              {
                "name": "hello",
                "image": "__IMAGE__",
                "essential": true,
                "portMappings": [
                  { "containerPort": 8080, "protocol": "tcp" }
                ]
              }
            ]
          }
          EOF

          # Replace placeholders
          sed -i "s|__IMAGE__|$IMAGE_URI|g" taskdef.json
          sed -i "s|__EXEC_ROLE__|$ECS_EXEC_ROLE_ARN|g" taskdef.json

          # Task role optional; if empty remove it
          if [ -z "${ECS_TASK_ROLE_ARN:-}" ] || [ "$ECS_TASK_ROLE_ARN" = "null" ]; then
            jq 'del(.taskRoleArn)' taskdef.json > taskdef.tmp && mv taskdef.tmp taskdef.json
          else
            sed -i "s|__TASK_ROLE__|$ECS_TASK_ROLE_ARN|g" taskdef.json
          fi

          echo "Registering task definition..."
          TASKDEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://taskdef.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "TASKDEF_ARN=$TASKDEF_ARN" >> $GITHUB_ENV
          echo "TaskDef ARN: $TASKDEF_ARN"

      - name: Create AppSpec and trigger CodeDeploy (Blue/Green)
        run: |
          cat > appspec.yaml <<EOF
          version: 1
          Resources:
            - TargetService:
                Type: AWS::ECS::Service
                Properties:
                  TaskDefinition: "$TASKDEF_ARN"
                  LoadBalancerInfo:
                    ContainerName: "hello"
                    ContainerPort: 8080
          EOF

          # JSON-encode appspec content safely
          APPSPEC_JSON=$(jq -Rs '.' < appspec.yaml)

          echo "Triggering CodeDeploy deployment..."
          aws deploy create-deployment \
            --application-name "$CD_APP" \
            --deployment-group-name "$CD_DG" \
            --revision "revisionType=AppSpecContent,appSpecContent={content=$APPSPEC_JSON}" \
            --description "GitHub Actions ECS Blue/Green deploy ($GITHUB_SHA)" \
            --output table

      - name: Print ALB URL
        run: |
          echo "ALB URL: $ALB_URL"
